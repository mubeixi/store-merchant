
tinymce.PluginManager.add('funimgs', function (editor, url) {
	var pluginName = '多图片上传'
	window.funimgs = {} // 扔外部公共变量，也可以扔一个自定义的位置

	var baseURL = tinymce.baseURL
	var iframe1 = baseURL + '/plugins/axupimgs/upfiles.html'
	funimgs.images_upload_handler = editor.getParam('images_upload_handler', undefined, 'function')
	funimgs.images_upload_base_path = editor.getParam('images_upload_base_path', '', 'string')
	funimgs.axupimgs_filetype = editor.getParam('axupimgs_filetype', '.png,.gif,.jpg,.jpeg', 'string')
	funimgs.res = []
	funimgs.files = []



	//console.log(window.CKFinder)

		// <svg width="24" height="24"><path d="M5 15.7l3.3-3.2c.3-.3.7-.3 1 0L12 15l4.1-4c.3-.4.8-.4 1 0l2 1.9V5H5v10.7zM5 18V19h3l2.8-2.9-2-2L5 17.9zm14-3l-2.5-2.4-6.4 6.5H19v-4zM4 3h16c.6 0 1 .4 1 1v16c0 .6-.4 1-1 1H4a1 1 0 01-1-1V4c0-.6.4-1 1-1zm6 8a2 2 0 100-4 2 2 0 000 4z" fill-rule="nonzero"></path></svg>

	editor.ui.registry.getAll().icons.funimgs || editor.ui.registry.addIcon('funimgs', '<svg t="1594779307093" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7305" width="24" height="24"><path d="M898.315712 878.384523c0 10.772078-8.78766 19.564758-19.506196 19.564758H145.70583c-10.787137-0.033464-19.509542-8.780967-19.509542-19.564758V555.869699c0-10.777098 8.739137-19.511216 19.509542-19.511215h223.944784c27.504105 53.438745 82.527373 87.063425 142.632157 87.16549 60.104784-0.110431 115.11634-33.761882 142.566902-87.222379h223.954824c10.775425 0 19.506196 8.735791 19.506196 19.504523v322.578405h0.005019zM253.908497 148.120261c3.517072-11.339294 19.854222-22.118065 33.688261-22.118065h449.435608c15.309804 0 30.402092 11.73919 33.691608 22.174954l101.054745 323.078693h-238.297516a32.555503 32.555503 0 0 0-30.793621 22.007634c-13.059346 38.82834-49.374536 65.045752-90.341229 65.214745-40.975059-0.174013-77.303634-26.388078-90.393098-65.214745a32.560523 32.560523 0 0 0-30.853856-22.007634H152.793516L253.858301 148.118588l0.050196 0.001673z m701.339608 371.964654l-122.384732-391.311895c-12.075503-38.617516-53.303216-67.824941-95.892915-67.824942H287.536523c-42.646588 0-83.820758 29.150536-95.844392 67.824942l-122.383059 391.311895c-5.103268 10.999634-8.227137 23.018248-8.227137 35.838327v322.519843c0 46.67566 37.996758 84.608837 84.615529 84.608837h733.157229c46.620444 0 84.615529-37.936523 84.615529-84.608837V555.873046c0.008366-12.818405-3.115503-24.905621-8.222117-35.788131zM653.385621 726.743843H371.191634c-14.376157 0-26.031686 11.65051-26.031686 26.026667 0 14.379503 11.653856 26.033359 26.031686 26.033359h282.128732c14.381176 0 26.030013-11.653856 26.030013-26.033359 0-14.376157-11.648837-26.026667-26.030013-26.026667h0.065255zM279.255843 413.127111h466.000314c10.803869 0 19.559739-8.760889 19.559738-19.566431 0-10.807216-8.755869-19.563085-19.559738-19.563085H279.255843c-10.805542 0-19.566431 8.755869-19.566431 19.563085 0 10.800523 8.760889 19.566431 19.566431 19.566431z m29.888418-99.354771h406.158223c10.797176 0 19.541333-8.74583 19.541333-19.53966 0-10.792157-8.749176-19.531294-19.541333-19.531294H309.144261c-10.807216 0-19.566431 8.755869-19.566431 19.561411 0 10.808889 8.759216 19.564758 19.566431 19.564759v-0.055216z m24.381909-99.358118h357.451294c10.772078-0.824889 18.833569-10.223268 18.020392-20.998693a19.554719 19.554719 0 0 0-18.020392-18.022065H333.52617c-10.775425 0.816523-18.836915 10.219922-18.020392 20.998693a19.583163 19.583163 0 0 0 18.020392 18.022065z" p-id="7306"></path></svg>')


	const opt = {}
	const options = Object.assign({limit:10,type:'img'},opt);

	const callFn = {
		up:(url)=>{

			// insertImages( editor, [url] );
			// editor.editing.view.focus();
		},
		choose:(urls)=>{
			console.log(urls)
			var html = ''

			var len = urls.length
			for (let i = 0; i < len; i++) {
				if (urls[i]) {
					html += '<img src="' + urls[i] + '" />'
				}
			}
			editor.insertContent(html)
			// insertImages( editor, urls );
			// editor.editing.view.focus();
		},
		chooseMedia:(urls)=>{
			var html = ''
			var len = urls.length
			for (let i = 0; i < len; i++) {
				if (urls[i]) {
					var medieHtmlTmpl = `<video poster="" controls="controls" width="300" height="150"><source src="${urls[i]}" type="video/mp4" /></video>`
					html += medieHtmlTmpl
				}
			}
			editor.insertContent(html)

			// insertMediaFunc(editor, urls)
			// editor.editing.view.focus();
		}
	}






	function upFile (currentFile) {
		return new Promise((resolve, reject) => {

			var blobInfo = {file:null}
			blobInfo.blob = function(){return this.file;}
			blobInfo.file= currentFile;
			funimgs.images_upload_handler(blobInfo,function(url){
				resolve(url)
			},function(err){
				reject(err)
			},function(process){
				console.log(process)
			});
		})
	}

	function upAllFiles(){

		var len = funimgs.files.length;
		//上传完毕
		// if(len == 0){
		// 	callFn.choose(funimgs.res)
		// 	funimgs.res = []
		// 	return true;
		// }
		const taskList = []
		for (var i = 0; i < funimgs.files.length; i++) {
			var taskItem = upFile(funimgs.files[i])
			taskList.push(taskItem)
		}

		Promise.all(taskList).then((urls) => {
			// console.log(urls);
			callFn.choose(urls)
		});


	}

	function uploadimage () {

		var input = document.createElement('input');
		input.setAttribute('type', 'file');
		input.setAttribute('multiple', 'multiple');
		input.setAttribute('accept', funimgs.axupimgs_filetype);
		input.click();
		input.onchange = function() {
			var files = this.files;

			funimgs.files = files
			upAllFiles()
		}

	}


	editor.ui.registry.addSplitButton('funimgs', {
		icon: 'funimgs',
		tooltip: pluginName,
		onAction: function () {
			//editor.insertContent('<p>You clicked the main button</p>');
		},
		onItemAction: function (api, value) {
			if(value === 'FUNFinder'){
				window.FUNFinder.open({editor,options,callFn});
			}
			if(value === 'upload'){
				uploadimage()
			}

		},
		fetch: function (callback) {
			var items = [
				{
					type: 'choiceitem',
					// icon: 'notice',
					text: '素材库选择',
					value: 'FUNFinder'
				},
				{
					type: 'choiceitem',
					// icon: 'warning',
					text: '直接上传图片',
					value: 'upload'
				}
			];
			callback(items);
		}
		// onAction: function () {
		// 	// openDialog()
		// 	// window.FUNFinder.open({editor,options,callFn});
		// }
	})
	editor.ui.registry.addMenuItem('funimgs', {
		icon: 'funimgs',
		text: '图片批量上传...',

		onAction: function () {
			// openDialog()
			// window.FUNFinder.open({editor,options,callFn});
		}
	})
	return {
		getMetadata: function () {
			return {
				name: pluginName,
				url: 'http://tinymce.ax-z.cn/more-plugins/funimgs.php'
			}
		}
	}
})
