tinymce.PluginManager.add('lplink', function (editor, url) {
  var pluginName = '绑定链接'

  window.lplink = {} // 扔外部公共变量，也可以扔一个自定义的位置
  var openDialog = function () {
    return editor.windowManager.open({
      title: '请输入小程序路由',
      body: {
        type: 'panel',
        items: [
          {
            type: 'input',
            name: 'title',
            label: '请输入小程序包含参数的地址，仅支持当前系统绑定的小程序使用'
          },
          {
            type: 'input',
            name: 'label',
            label: '显示名称'
          },
        ]
      },
      buttons: [
        {
          type: 'cancel',
          text: '取消'
        },
        {
          type: 'submit',
          text: '确认',
          primary: true
        }
      ],
      onSubmit: function (api) {
        var data = api.getData();
        if(!data.label)data.label = '自定义链接'
        if(data.title && data.label){
          // 将输入框内容插入到内容区光标位置
          editor.insertContent(`<p><span class="link-min-ele" data-type="link-mini" data-url="${data.title}">${data.label}</span></p>`);
          api.close();
        }else{
          alert('两项内容必填')
        }


      }
    });
  };

  function openBindLinkComp(){
    editor.vm.bindLinkDialogShow = true
  }
// <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M402.2 734.6c-71.9 0-130.4-54.1-130.4-121 0-20.8 6-41.2 16.9-59.5 16.4-26.8 42.7-46.6 74.4-56 8.4-2.5 14.9-3.5 20.8-3.5 13.9 0 24.8 10.9 24.8 24.8s-10.9 24.8-24.8 24.8c-1 0-3 0-5.5 1-21.3 6-38.2 18.4-47.6 34.7-6.5 10.4-9.4 21.8-9.4 33.7 0 39.2 36.2 71.4 80.4 71.4 15.4 0 30.3-4 43.7-11.4 23.3-13.4 37.2-35.7 37.2-60V405.7c0-42.2 23.3-80.8 62-102.7 20.8-11.9 44.1-17.9 68-17.9 71.9 0 130.4 54.1 130.4 121 0 20.8-6 41.2-16.9 59.5-16.4 26.8-42.7 46.6-74.4 56-8.9 2.5-14.9 3.5-20.8 3.5-13.9 0-24.8-10.9-24.8-24.8s10.9-24.8 24.8-24.8c1 0 3 0 5.5-1 21.3-6.4 38.2-18.9 47.6-34.7 6.4-10.4 9.4-21.8 9.4-33.7 0-39.2-36.2-71.4-80.8-71.4-15.4 0-30.3 4-43.7 11.4-23.3 13.4-37.2 35.7-37.2 60v207.3c0 42.2-23.3 80.9-62 102.7-20.5 12.5-43.8 18.5-67.6 18.5z m504.4-223.2c0-219.2-177.6-396.8-396.8-396.8S113 292.1 113 511.4s177.6 396.8 396.8 396.8 396.8-177.6 396.8-396.8z m49.6 0c0 246.5-199.9 446.4-446.4 446.4-246.5 0-446.4-199.9-446.4-446.4C63.4 264.9 263.3 65 509.8 65c246.5 0 446.4 199.9 446.4 446.4z m0 0"></path></svg>

  editor.ui.registry.getAll().icons.lplink || editor.ui.registry.addIcon('lplink', '<svg t="1594794295579" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5055" width="22" height="22"><path d="M713.1 100.3c137.3 0 249 103.2 249 231 0 39.8-11.4 78.6-32.2 113.6-31.2 51.1-81.4 89-142 107-16.1 4.7-28.4 6.6-39.8 6.6-26.5 0-47.3-20.8-47.3-47.3 0-26.5 20.8-47.3 47.3-47.3 1.9 0 5.7 0 10.4-1.9 40.7-11.4 72.9-35 90.9-66.3 12.3-19.9 18-41.7 18-64.4 0-74.8-69.1-136.3-153.4-136.3-29.4 0-57.8 7.6-83.3 21.8-44.5 25.6-71 68.2-71 114.6v396.7c0 80.5-44.5 154.3-118.4 196-39.8 22.7-84.3 34.1-129.7 34.1-137.3 0-249-103.2-249-231 0-39.8 11.4-78.6 32.2-113.6 31.2-51.1 81.4-89 142-107 17-4.7 28.4-6.6 39.8-6.6 26.5 0 47.3 20.8 47.3 47.3 0 26.5-20.8 47.3-47.3 47.3-1.9 0-5.7 0-10.4 1.9-40.7 12.3-72.9 36-90.9 66.3-12.3 19.9-18 41.7-18 64.4 0 74.8 69.1 136.3 154.3 136.3 29.4 0 57.8-7.6 83.3-21.8 44.5-25.6 71-68.2 71-114.6V331.4c0-80.5 44.5-154.3 118.4-196 38.8-23.7 83.3-35.1 128.8-35.1z" p-id="5056"></path></svg>')

  var isImageFigure = function (elm) {
    return elm && elm.nodeName === 'FIGURE' && /\bimage\b/i.test(elm.className);
  };

  var getAnchorElement = function (editor, selectedElm) {
    selectedElm = selectedElm || editor.selection.getNode();
    // console.log(selectedElm,editor.dom.getParent(selectedElm, 'span[data-url]'))
    if (isImageFigure(selectedElm)) {
      return editor.dom.select('span[data-url]', selectedElm)[0];
    } else {
      return editor.dom.getParent(selectedElm, 'span[data-url]');
    }
  };

  var toggleActiveState = function (editor) {
    return function (api) {
      var nodeChangeHandler = function (e) {
        // console.log(e)
        return api.setActive(!editor.mode.isReadOnly() && !!getAnchorElement(editor, e.element));
      };
      editor.on('NodeChange', nodeChangeHandler);
      return function () {
        return editor.off('NodeChange', nodeChangeHandler);
      };
    };
  };


  editor.ui.registry.addToggleButton('lplink', {
    icon: 'lplink',
    tooltip: pluginName,
    onSetup: toggleActiveState(editor),
    onAction: function () {
      openBindLinkComp()
      // openDialog()
    }
  })
  editor.ui.registry.addMenuItem('lplink', {
    icon: 'lplink',
    text: pluginName,
    onAction: function () {
      openBindLinkComp()
      // openDialog()
    }
  })
  return {
    getMetadata: function () {
      return {
        name: pluginName,
        url: 'http://tinymce.ax-z.cn/more-plugins/lplink.php'
      }
    }
  }
})
